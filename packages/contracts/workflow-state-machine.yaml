# Workflow Task State Machine
# Generated from spreadsheet tables — do not edit by hand.

$schema: ./schemas/state-machine-schema.yaml

version: "1.0"
object: Task
domain: workflow
apiSpec: workflow-openapi.yaml

# States — map keyed by state name for overlay targeting (e.g., $.states.pending.slaClock)
states:
  pending:
    slaClock: running
  in_progress:
    slaClock: running
  completed:
    slaClock: stopped

initialState: pending

# Guards — named map, referenced by string in transitions. Reusable across transitions.
guards:
  taskIsUnassigned:
    field: assignedToId
    operator: is_null
  workerHasRequiredSkills:
    field: $caller.skills
    operator: contains_all
    value: $object.requiredSkills
  callerIsAssignedWorker:
    field: assignedToId
    operator: equals
    value: $caller.id

# Effects that run when a Task is created (not a state transition — no "from" state).
onCreate:
  actors:
    - supervisor
    - system
  effects:
    - type: lookup
      entity: SLAType
      lookupField: slaTypeCode
      bindTo: $bound.slaType
      description: Load SLA configuration by task's slaTypeCode
    - type: set
      field: dueDate
      value: $bound.slaType.durationDays
      relativeTo: $now
      description: Compute SLA deadline from SLAType duration
    - type: set
      field: slaInfo
      value:
        slaStatus: on_track
        clockStartDate: $now
        slaDeadline: $bound.slaType.durationDays
      description: Initialize SLA tracking info
    - type: evaluate-rules
      ruleTypes:
        - assignment
        - priority
      description: Route task to queue and set priority
    - type: create
      entity: TaskAuditEvent
      fields:
        taskId: $object.id
        eventType: created
        previousValue: null
        newValue: pending
        performedById: $caller.id
        occurredAt: $now
      description: Audit record for task creation

# Transitions — ordered array of valid state changes
transitions:
  - trigger: claim
    from: pending
    to: in_progress
    actors:
      - caseworker
    guards:
      - taskIsUnassigned
      - workerHasRequiredSkills
    effects:
      - type: set
        field: assignedToId
        value: $caller.id
        description: Assign task to the claiming worker
      - type: create
        entity: TaskAuditEvent
        fields:
          taskId: $object.id
          eventType: assigned
          previousValue: pending
          newValue: in_progress
          performedById: $caller.id
          occurredAt: $now
        description: Audit record for task claim
      - type: event
        name: task.claimed
        schema: TaskClaimedEvent
        payload:
          taskId: $object.id
          claimedById: $caller.id
          queueId: $object.queueId
          claimedAt: $now
        description: Emit task claimed domain event

  - trigger: complete
    from: in_progress
    to: completed
    actors:
      - caseworker
    guards:
      - callerIsAssignedWorker
    effects:
      - type: set
        field: outcomeInfo
        value:
          outcome: $request.outcome
          notes: $request.notes
        description: Record completion outcome from request
      - type: create
        entity: TaskAuditEvent
        fields:
          taskId: $object.id
          eventType: completed
          previousValue: in_progress
          newValue: completed
          performedById: $caller.id
          occurredAt: $now
        description: Audit record for task completion
      - type: create
        entity: Task
        fields:
          programType: $object.programType
          slaTypeCode: $object.slaTypeCode
          applicationId: $object.applicationId
          caseId: $object.caseId
          status: pending
        when:
          "==":
            - var: $request.createFollowUp
            - true
        description: Create follow-up task when requested

  - trigger: release
    from: in_progress
    to: pending
    actors:
      - caseworker
    guards:
      - callerIsAssignedWorker
    effects:
      - type: set
        field: assignedToId
        value: null
        description: Clear assignment so task returns to queue
      - type: create
        entity: TaskAuditEvent
        fields:
          taskId: $object.id
          eventType: returned_to_queue
          previousValue: in_progress
          newValue: pending
          performedById: $caller.id
          reason: $request.reason
          occurredAt: $now
        description: Audit record for task release
      - type: evaluate-rules
        ruleTypes:
          - assignment
        description: Re-evaluate routing rules for released task

# Request bodies — what each RPC endpoint accepts
requestBodies:
  claim: {}
  complete:
    type: object
    properties:
      outcome:
        type: string
        description: Completion outcome (e.g., approved, denied)
      notes:
        type: string
        description: Optional notes about the completion
      createFollowUp:
        type: boolean
        description: Whether to create a follow-up task
    required:
      - outcome
  release:
    type: object
    properties:
      reason:
        type: string
        description: Why the task is being released
    required:
      - reason

# Audit — declarative requirements validated by the validation script
audit:
  entity: TaskAuditEvent
  scope: all
  requiredFields:
    - taskId
    - eventType
    - performedById
    - occurredAt
