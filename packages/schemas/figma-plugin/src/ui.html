<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      padding: 16px;
      background: #fff;
    }

    h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }

    .section {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #666;
    }

    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
    }

    select:focus {
      outline: none;
      border-color: #18a0fb;
    }

    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 6px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: normal;
      cursor: pointer;
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    button {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button.primary {
      background: #18a0fb;
      color: white;
    }

    button.primary:hover {
      background: #0d8de5;
    }

    button.primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    button.secondary:hover {
      background: #e0e0e0;
    }

    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      font-size: 11px;
    }

    .status.success {
      background: #e6f7e6;
      color: #1a7f1a;
    }

    .status.error {
      background: #ffe6e6;
      color: #cc0000;
    }

    .status.info {
      background: #e6f0ff;
      color: #0066cc;
    }

    .help-text {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 16px;
    }

    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      font-size: 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }

    .tab.active {
      border-bottom-color: #18a0fb;
      color: #18a0fb;
      font-weight: 500;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .field-browser {
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      background: #fafafa;
    }

    .field-item {
      display: flex;
      align-items: flex-start;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }

    .field-item:last-child {
      border-bottom: none;
    }

    .field-name {
      font-weight: 500;
      color: #333;
      min-width: 100px;
      flex-shrink: 0;
      font-size: 11px;
    }

    .field-type {
      font-size: 9px;
      padding: 2px 5px;
      border-radius: 10px;
      margin-left: 6px;
      flex-shrink: 0;
    }

    .field-type.text { background: #e3f2fd; color: #1565c0; }
    .field-type.dropdown { background: #f3e5f5; color: #7b1fa2; }
    .field-type.date { background: #fff3e0; color: #ef6c00; }
    .field-type.boolean { background: #e8f5e9; color: #2e7d32; }

    .example-preview {
      margin-bottom: 16px;
    }

    .preview-content {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      background: #fafafa;
      font-size: 11px;
    }

    .preview-row {
      display: flex;
      padding: 3px 0;
      border-bottom: 1px solid #eee;
    }

    .preview-row:last-child {
      border-bottom: none;
    }

    .preview-label {
      font-weight: 500;
      color: #666;
      min-width: 120px;
      flex-shrink: 0;
    }

    .preview-value {
      color: #333;
    }

    .field-filter {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 8px;
    }

    .field-filter:focus {
      outline: none;
      border-color: #18a0fb;
    }

    .empty-state {
      text-align: center;
      padding: 32px 24px;
      color: #666;
    }

    .empty-state p {
      margin-bottom: 12px;
    }

    .file-drop-zone {
      display: block;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 32px 24px;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.2s;
      color: #888;
    }

    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
      border-color: #18a0fb;
      background: #f0f8ff;
      color: #18a0fb;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 8px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      border-color: #18a0fb;
      background: #f8fcff;
    }

    .action-btn.active {
      border-color: #18a0fb;
      background: #e6f4ff;
    }

    .action-icon {
      font-size: 16px;
      margin-bottom: 2px;
    }

    .action-label {
      font-weight: 500;
      font-size: 11px;
      color: #333;
    }

    .action-desc {
      font-size: 9px;
      color: #888;
      margin-top: 2px;
    }

    .reload-link {
      color: #18a0fb;
      cursor: pointer;
      text-decoration: underline;
    }

    .reload-link:hover {
      color: #0d8de5;
    }
  </style>
</head>
<body>
  <h2>Safety Net Schema Populator</h2>

  <div class="tabs">
    <button class="tab active" data-tab="browse">Browse</button>
    <button class="tab" data-tab="help">Help</button>
  </div>

  <div id="browse-tab" class="tab-content active">
    <div id="browse-empty-state" class="empty-state">
      <p><strong>Load your schema data</strong></p>
      <p class="help-text">Drop the all-data.json file here or click to browse</p>
      <label class="file-drop-zone" id="file-drop-zone">
        <input type="file" id="file-input" accept=".json" style="display: none;">
        <span>Drop JSON file here<br>or click to select</span>
      </label>
      <p class="help-text" style="margin-top: 16px;">
        Generate with: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">npm run figma:export</code>
      </p>
    </div>

    <div id="browse-content" style="display: none;">
      <div class="section">
        <label for="resource-select">Resource Type</label>
        <select id="resource-select">
          <option value="">-- Select --</option>
        </select>
      </div>

      <div class="section">
        <label for="browse-example-select">Example</label>
        <select id="browse-example-select" disabled>
          <option value="">-- Select resource type first --</option>
        </select>
      </div>

      <div id="example-preview" class="example-preview" style="display: none;">
        <label>Preview</label>
        <div id="preview-content" class="preview-content"></div>
      </div>

      <div class="section">
        <label>Fields</label>
        <div id="field-browser" class="field-browser">
          <p class="help-text">Select a resource type to see available fields</p>
        </div>
      </div>

      <div class="section">
        <label>Action</label>
        <div class="action-buttons">
          <button class="action-btn active" id="action-populate" data-action="populate">
            <span class="action-icon">&#9998;</span>
            <span class="action-label">Populate Existing</span>
            <span class="action-desc">Fill matching layers</span>
          </button>
          <button class="action-btn" id="action-generate" data-action="generate">
            <span class="action-icon">+</span>
            <span class="action-label">Generate Layout</span>
            <span class="action-desc">Create new layers</span>
          </button>
        </div>
      </div>

      <div id="layout-options" class="section" style="display: none;">
        <label>Layout Style</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="layout-style" value="form" checked>
            Form (label + value)
          </label>
          <label>
            <input type="radio" name="layout-style" value="autolayout">
            Grouped (auto-layout)
          </label>
        </div>
      </div>

      <div class="button-row">
        <button class="secondary" id="browse-cancel-btn">Cancel</button>
        <button class="primary" id="browse-populate-btn" disabled>Populate Selection</button>
        <button class="primary" id="browse-generate-btn" disabled style="display: none;">Generate Layout</button>
      </div>

      <div id="browse-status" class="status" style="display: none;"></div>

      <p class="help-text" style="margin-top: 12px; text-align: center;">
        <span class="reload-link" id="reload-data">Load different data</span>
      </p>
    </div>
  </div>

  <div id="help-tab" class="tab-content">
    <div class="section">
      <h3 style="margin-bottom: 12px;">Quick Start</h3>
      <ol style="padding-left: 20px; line-height: 1.8;">
        <li>Export your schema data:<br>
          <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">npm run figma:export</code>
        </li>
        <li>Drop the generated <code>all-data.json</code> file into the plugin</li>
        <li>Select a resource type and example</li>
        <li>Choose an action:
          <ul style="padding-left: 16px; margin-top: 4px;">
            <li><strong>Populate Existing</strong> - fills matching text layers in your selection</li>
            <li><strong>Generate Layout</strong> - creates a new frame with all fields</li>
          </ul>
        </li>
      </ol>
    </div>

    <div class="section">
      <h3 style="margin-bottom: 12px;">Populate Existing</h3>
      <p style="line-height: 1.6;">
        Name your text layers to match field names. The plugin uses fuzzy matching:
      </p>
      <ul style="padding-left: 20px; margin-top: 8px; line-height: 1.8;">
        <li><strong>First Name</strong> matches firstName, first_name</li>
        <li><strong>Date of Birth</strong> matches dateOfBirth, DOB</li>
        <li><strong>Address Line 1</strong> matches address.addressLine1</li>
      </ul>
    </div>

    <div class="section">
      <h3 style="margin-bottom: 12px;">Generate Layout</h3>
      <p style="line-height: 1.6;">
        Creates a new frame with all fields from the selected example:
      </p>
      <ul style="padding-left: 20px; margin-top: 8px; line-height: 1.8;">
        <li><strong>Form</strong> - simple vertical list of label + value pairs</li>
        <li><strong>Grouped</strong> - fields grouped by category with auto-layout</li>
      </ul>
    </div>
  </div>

  <script>
    let browseData = null;
    let groupedExamples = {};

    // Infer resource type from example name
    function inferResourceType(example) {
      const name = example.__exampleName || example._name || '';
      if (name.toLowerCase().includes('application')) return 'applications';
      if (name.toLowerCase().includes('household')) return 'households';
      if (name.toLowerCase().includes('income')) return 'incomes';
      if (name.toLowerCase().includes('person')) return 'persons';
      // Fallback: check for characteristic fields
      if (example.status && example.screeningFlags) return 'applications';
      if (example.homeAddress || example['homeAddress.addressLine1']) return 'households';
      if (example.personId && (example.type || example.amount)) return 'incomes';
      if (example['name.firstName'] || example.dateOfBirth) return 'persons';
      return 'other';
    }

    // Get display name for an example
    function getExampleDisplayName(example, index) {
      const name = example.__exampleName || example._name || '';
      if (name) {
        return name
          .replace(/([a-z])([A-Z])/g, '$1 $2')
          .replace(/(\D)(\d)/g, '$1 $2');
      }
      return `Example ${index + 1}`;
    }

    // Group examples by resource type
    function groupExamplesByResource(examples) {
      const grouped = {};
      for (const example of examples) {
        const resourceType = example.__resourceType || inferResourceType(example);
        if (!grouped[resourceType]) {
          grouped[resourceType] = [];
        }
        grouped[resourceType].push(example);
      }
      return grouped;
    }

    // Render field browser
    function renderFieldBrowser(fields, filter = '') {
      const container = document.getElementById('field-browser');
      const filtered = filter
        ? fields.filter(f =>
            f.label.toLowerCase().includes(filter.toLowerCase()) ||
            f.key.toLowerCase().includes(filter.toLowerCase())
          )
        : fields;

      if (filtered.length === 0) {
        container.innerHTML = '<p class="help-text">No fields match your filter</p>';
        return;
      }

      container.innerHTML = `
        <input type="text" class="field-filter" placeholder="Filter fields..." value="${filter}" id="field-filter-input">
        ${filtered.slice(0, 50).map(f => `
          <div class="field-item">
            <span class="field-name">${f.label}</span>
            <span class="field-type ${f.type}">${f.type}</span>
          </div>
        `).join('')}
        ${filtered.length > 50 ? `<p class="help-text">...and ${filtered.length - 50} more</p>` : ''}
      `;

      // Add filter event listener
      document.getElementById('field-filter-input')?.addEventListener('input', (e) => {
        renderFieldBrowser(fields, e.target.value);
      });
    }

    // Render example preview
    function renderExamplePreview(example, metadata) {
      const container = document.getElementById('preview-content');
      const previewEl = document.getElementById('example-preview');

      if (!example) {
        previewEl.style.display = 'none';
        return;
      }

      previewEl.style.display = 'block';

      const entries = Object.entries(example)
        .filter(([key]) => !key.startsWith('_'))
        .slice(0, 20);

      container.innerHTML = entries.map(([key, value]) => {
        const meta = metadata[key];
        const label = meta?.label || key;
        return `
          <div class="preview-row">
            <span class="preview-label">${label}</span>
            <span class="preview-value">${value}</span>
          </div>
        `;
      }).join('');

      if (Object.keys(example).filter(k => !k.startsWith('_')).length > 20) {
        container.innerHTML += '<p class="help-text">...and more fields</p>';
      }
    }

    // Update browse tab when data is loaded
    function updateBrowseTab(data) {
      browseData = data;
      groupedExamples = groupExamplesByResource(data.examples);

      // Show content, hide empty state
      document.getElementById('browse-empty-state').style.display = 'none';
      document.getElementById('browse-content').style.display = 'block';

      const resourceSelect = document.getElementById('resource-select');
      const resourceTypes = Object.keys(groupedExamples).sort();

      resourceSelect.innerHTML = resourceTypes.map(rt =>
        `<option value="${rt}">${rt.charAt(0).toUpperCase() + rt.slice(1)} (${groupedExamples[rt].length})</option>`
      ).join('');

      // Trigger initial selection
      if (resourceTypes.length > 0) {
        resourceSelect.value = resourceTypes[0];
        onResourceTypeChange(resourceTypes[0]);
      }
    }

    // Handle resource type change
    function onResourceTypeChange(resourceType) {
      const examples = groupedExamples[resourceType] || [];
      const metadata = browseData?.metadata || {};

      // Update fields - get fields that appear in examples for this resource
      const fieldsInExamples = new Set();
      for (const ex of examples) {
        for (const key of Object.keys(ex)) {
          if (!key.startsWith('_')) fieldsInExamples.add(key);
        }
      }

      const fields = [];
      for (const [key, meta] of Object.entries(metadata)) {
        if (fieldsInExamples.has(key)) {
          fields.push({ key, ...meta });
        }
      }
      fields.sort((a, b) => a.label.localeCompare(b.label));
      renderFieldBrowser(fields);

      // Update examples dropdown
      const exampleSelect = document.getElementById('browse-example-select');
      exampleSelect.disabled = examples.length === 0;
      exampleSelect.innerHTML = examples.map((ex, i) => {
        const displayName = getExampleDisplayName(ex, i);
        return `<option value="${i}">${displayName}</option>`;
      }).join('');

      // Show first example preview
      if (examples.length > 0) {
        renderExamplePreview(examples[0], metadata);
        document.getElementById('browse-populate-btn').disabled = false;
        document.getElementById('browse-generate-btn').disabled = false;
      } else {
        renderExamplePreview(null, metadata);
        document.getElementById('browse-populate-btn').disabled = true;
        document.getElementById('browse-generate-btn').disabled = true;
      }
    }

    // Load data from file
    function loadDataFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const data = JSON.parse(text);

          // Support both formats:
          // 1. all-data.json: { metadata: {...}, examples: [...] }
          // 2. all-examples.json: { applications: [...], households: [...], ... }

          if (data.examples && Array.isArray(data.examples)) {
            // Format 1: all-data.json
            updateBrowseTab(data);
          } else if (data.applications || data.households || data.incomes || data.persons) {
            // Format 2: all-examples.json - convert to expected format
            const examples = [];
            for (const [resourceType, resourceExamples] of Object.entries(data)) {
              if (Array.isArray(resourceExamples)) {
                resourceExamples.forEach((ex, i) => {
                  ex.__resourceType = resourceType;
                  // Generate example name like "Application Example 1"
                  const typeName = resourceType.charAt(0).toUpperCase() + resourceType.slice(0, -1);
                  ex.__exampleName = `${typeName}Example${i + 1}`;
                  examples.push(ex);
                });
              }
            }
            updateBrowseTab({ metadata: {}, examples: examples });
          } else {
            throw new Error('Unrecognized JSON format. Use all-data.json from design-export/figma-plugin/');
          }
        } catch (err) {
          alert('Error loading file: ' + err.message);
        }
      };
      reader.onerror = () => {
        alert('Error reading file');
      };
      reader.readAsText(file);
    }

    // File input change handler
    document.getElementById('file-input').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        loadDataFromFile(e.target.files[0]);
      }
    });

    // Drag and drop handlers
    const dropZone = document.getElementById('file-drop-zone');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        loadDataFromFile(e.dataTransfer.files[0]);
      }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // Resource type change
    document.getElementById('resource-select').addEventListener('change', (e) => {
      onResourceTypeChange(e.target.value);
    });

    // Example change
    document.getElementById('browse-example-select').addEventListener('change', (e) => {
      const resourceType = document.getElementById('resource-select').value;
      const examples = groupedExamples[resourceType] || [];
      const exampleIndex = parseInt(e.target.value) || 0;
      renderExamplePreview(examples[exampleIndex], browseData?.metadata || {});
    });

    // Populate button
    document.getElementById('browse-populate-btn').addEventListener('click', () => {
      if (!browseData) return;

      const resourceType = document.getElementById('resource-select').value;
      const examples = groupedExamples[resourceType] || [];
      const exampleIndex = parseInt(document.getElementById('browse-example-select').value) || 0;

      parent.postMessage({
        pluginMessage: {
          type: 'populate',
          data: { metadata: browseData.metadata, examples: [examples[exampleIndex]] },
          exampleIndex: 0,
          matchMode: 'fuzzy'
        }
      }, '*');
    });

    // Cancel button
    document.getElementById('browse-cancel-btn').addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });

    // Action toggle (Populate vs Generate)
    let currentAction = 'populate';
    document.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentAction = btn.dataset.action;

        const layoutOptions = document.getElementById('layout-options');
        const populateBtn = document.getElementById('browse-populate-btn');
        const generateBtn = document.getElementById('browse-generate-btn');

        if (currentAction === 'generate') {
          layoutOptions.style.display = 'block';
          populateBtn.style.display = 'none';
          generateBtn.style.display = 'block';
        } else {
          layoutOptions.style.display = 'none';
          populateBtn.style.display = 'block';
          generateBtn.style.display = 'none';
        }
      });
    });

    // Generate button
    document.getElementById('browse-generate-btn').addEventListener('click', () => {
      if (!browseData) return;

      const resourceType = document.getElementById('resource-select').value;
      const examples = groupedExamples[resourceType] || [];
      const exampleIndex = parseInt(document.getElementById('browse-example-select').value) || 0;
      const layoutStyle = document.querySelector('input[name="layout-style"]:checked').value;
      const example = examples[exampleIndex];
      const exampleName = getExampleDisplayName(example, exampleIndex);

      parent.postMessage({
        pluginMessage: {
          type: 'generate',
          data: browseData,
          example: example,
          layoutStyle: layoutStyle,
          resourceType: resourceType,
          exampleName: exampleName
        }
      }, '*');
    });

    // Reload data link
    document.getElementById('reload-data').addEventListener('click', () => {
      document.getElementById('browse-empty-state').style.display = 'block';
      document.getElementById('browse-content').style.display = 'none';
      browseData = null;
      groupedExamples = {};
    });

    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      const browseStatusEl = document.getElementById('browse-status');

      if (msg.type === 'populate-result') {
        const total = msg.textMatched + msg.dropdownMatched;
        const cleared = msg.cleared || 0;

        if (total > 0 || cleared > 0) {
          browseStatusEl.className = 'status success';
          let html = `Populated ${total} field${total !== 1 ? 's' : ''}`;
          if (cleared > 0) {
            html += `, cleared ${cleared}`;
          }
          browseStatusEl.innerHTML = html;
        } else {
          browseStatusEl.className = 'status info';
          browseStatusEl.innerHTML = 'No matching layers found. Make sure your layer names match the field labels.';
        }
        browseStatusEl.style.display = 'block';
      }

      if (msg.type === 'generate-result') {
        browseStatusEl.className = 'status success';
        browseStatusEl.innerHTML = `Generated "${msg.frameName}" with ${msg.fieldCount} fields`;
        browseStatusEl.style.display = 'block';
      }

      if (msg.type === 'populate-error') {
        browseStatusEl.className = 'status error';
        browseStatusEl.innerHTML = msg.message;
        browseStatusEl.style.display = 'block';
      }
    };
  </script>
</body>
</html>
