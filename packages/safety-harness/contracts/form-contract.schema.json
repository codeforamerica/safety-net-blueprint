{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "form-contract.schema.json",
  "title": "FormContract",
  "description": "JSON Schema for form contract definitions that drive the form engine rendering pipeline.",
  "type": "object",
  "required": ["form"],
  "additionalProperties": false,
  "properties": {
    "form": {
      "type": "object",
      "required": ["id", "title", "schema", "layout", "pages"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this form contract."
        },
        "title": {
          "type": "string",
          "description": "Display title for the form."
        },
        "schema": {
          "type": "string",
          "description": "Name of the data schema this form operates on."
        },
        "layout": { "$ref": "#/$defs/LayoutConfig" },
        "resource": { "$ref": "#/$defs/ResourceBinding" },
        "actions": {
          "type": "array",
          "items": { "$ref": "#/$defs/ActionDefinition" }
        },
        "storybook": { "$ref": "#/$defs/StoryBookMeta" },
        "annotations": {
          "type": "array",
          "items": { "type": "string" }
        },
        "columns": {
          "type": "array",
          "items": { "$ref": "#/$defs/ReferenceColumn" }
        },
        "panels": {
          "type": "object",
          "required": ["left", "right"],
          "additionalProperties": false,
          "properties": {
            "left": { "$ref": "#/$defs/PanelConfig" },
            "right": { "$ref": "#/$defs/PanelConfig" }
          }
        },
        "pages": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Page" }
        }
      }
    }
  },
  "$defs": {
    "ComponentType": {
      "type": "string",
      "enum": ["text-input", "date-input", "radio", "select", "checkbox-group", "field-array", "textarea"]
    },
    "FieldWidth": {
      "type": "string",
      "enum": ["full", "half", "third", "two-thirds"]
    },
    "PermissionLevel": {
      "type": "string",
      "enum": ["editable", "read-only", "masked", "hidden"]
    },
    "Role": {
      "type": "string",
      "enum": ["applicant", "caseworker", "reviewer", "admin"]
    },
    "NavigationType": {
      "type": "string",
      "enum": ["step-indicator", "side-nav", "in-page", "top-nav", "none"]
    },
    "DisplayType": {
      "type": "string",
      "enum": ["paginated", "scrollable", "accordion", "split-panel", "data-table"]
    },
    "ActionStyle": {
      "type": "string",
      "enum": ["default", "secondary", "success", "warning", "outline"]
    },
    "HttpMethod": {
      "type": "string",
      "enum": ["GET", "POST", "PATCH", "PUT", "DELETE"]
    },
    "ViewMode": {
      "type": "string",
      "enum": ["editable", "readonly"]
    },
    "DataTableSource": {
      "type": "string",
      "enum": ["contract", "api"]
    },
    "SimpleCondition": {
      "type": "object",
      "required": ["field"],
      "additionalProperties": false,
      "properties": {
        "field": { "type": "string" },
        "equals": {},
        "not_equals": {}
      }
    },
    "JsonLogicCondition": {
      "type": "object",
      "required": ["jsonlogic"],
      "additionalProperties": false,
      "properties": {
        "jsonlogic": {
          "type": "object"
        }
      }
    },
    "ShowWhen": {
      "oneOf": [
        { "$ref": "#/$defs/SimpleCondition" },
        { "$ref": "#/$defs/JsonLogicCondition" }
      ]
    },
    "FieldDefinition": {
      "type": "object",
      "required": ["ref", "component"],
      "additionalProperties": false,
      "properties": {
        "ref": {
          "type": "string",
          "description": "Dot-path reference to the data field."
        },
        "component": { "$ref": "#/$defs/ComponentType" },
        "width": { "$ref": "#/$defs/FieldWidth" },
        "hint": { "type": "string" },
        "labels": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "permissions": {
          "type": "object",
          "propertyNames": { "$ref": "#/$defs/Role" },
          "additionalProperties": { "$ref": "#/$defs/PermissionLevel" }
        },
        "show_when": { "$ref": "#/$defs/ShowWhen" },
        "fields": {
          "type": "array",
          "items": { "$ref": "#/$defs/FieldDefinition" },
          "description": "Sub-fields for field-array component."
        },
        "min_items": {
          "type": "integer",
          "minimum": 0,
          "description": "Minimum number of rows (field-array)."
        },
        "max_items": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of rows (field-array)."
        }
      }
    },
    "ReferenceColumn": {
      "type": "object",
      "required": ["from", "label"],
      "additionalProperties": false,
      "properties": {
        "from": { "type": "string" },
        "label": { "type": "string" }
      }
    },
    "DetailConfig": {
      "type": "object",
      "required": ["form", "fetch"],
      "additionalProperties": false,
      "properties": {
        "form": {
          "type": "string",
          "description": "ID of the form contract to render for the detail view."
        },
        "fetch": {
          "type": "string",
          "description": "API endpoint template, e.g. '/api/applications/{id}'."
        }
      }
    },
    "Page": {
      "type": "object",
      "required": ["id", "title"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "title": { "type": "string" },
        "fields": {
          "type": "array",
          "items": { "$ref": "#/$defs/FieldDefinition" }
        },
        "expanded": {
          "type": "boolean",
          "description": "For review layout: whether this section starts expanded."
        },
        "display": { "$ref": "#/$defs/DisplayType" },
        "source": { "$ref": "#/$defs/DataTableSource" },
        "columns": {
          "type": "array",
          "items": { "$ref": "#/$defs/ReferenceColumn" }
        },
        "detail": { "$ref": "#/$defs/DetailConfig" }
      }
    },
    "LayoutConfig": {
      "type": "object",
      "required": ["navigation", "display"],
      "additionalProperties": false,
      "properties": {
        "navigation": { "$ref": "#/$defs/NavigationType" },
        "display": { "$ref": "#/$defs/DisplayType" }
      }
    },
    "ResourceBinding": {
      "type": "object",
      "required": ["endpoint"],
      "additionalProperties": false,
      "properties": {
        "endpoint": {
          "type": "string",
          "description": "Base REST endpoint, e.g. '/persons'."
        },
        "identity": {
          "type": "string",
          "description": "URL parameter name for the record ID, e.g. 'personId'."
        }
      }
    },
    "ActionCondition": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "role": {
          "type": "array",
          "items": { "$ref": "#/$defs/Role" }
        },
        "field": {
          "type": "object",
          "additionalProperties": {}
        }
      }
    },
    "ActionDefinition": {
      "type": "object",
      "required": ["id", "label", "method"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "label": { "type": "string" },
        "method": { "$ref": "#/$defs/HttpMethod" },
        "endpoint": { "type": "string" },
        "style": { "$ref": "#/$defs/ActionStyle" },
        "navigate": { "type": "string" },
        "confirm": { "type": "string" },
        "show_when": { "$ref": "#/$defs/ActionCondition" }
      }
    },
    "PanelConfig": {
      "type": "object",
      "required": ["label", "mode"],
      "additionalProperties": false,
      "properties": {
        "label": { "type": "string" },
        "mode": { "$ref": "#/$defs/ViewMode" }
      }
    },
    "StoryBookMeta": {
      "type": "object",
      "required": ["role", "permissions"],
      "additionalProperties": false,
      "properties": {
        "role": { "$ref": "#/$defs/Role" },
        "permissions": { "type": "string" }
      }
    }
  }
}
